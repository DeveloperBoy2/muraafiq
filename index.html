<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>Ù…Ø±Ø§ÙÙ‚ | ØªØªØ¨Ø¹ Ø§Ù„Ø¹Ø§Ø¯Ø§Øª</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700;800;900&family=Cairo:wght@300;400;600;700;900&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #080810;
  --bg2: #0e0e18;
  --bg3: #141420;
  --card: #181826;
  --card2: #1e1e2e;
  --border: rgba(255,255,255,0.055);
  --border2: rgba(255,255,255,0.1);
  --gold: #f5c842;
  --gold2: #e8a820;
  --gold3: #ffd96a;
  --goldfade: rgba(245,200,66,0.12);
  --teal: #2dd4bf;
  --teal2: rgba(45,212,191,0.15);
  --green: #4ade80;
  --red: #f87171;
  --orange: #fb923c;
  --text: #eeeef8;
  --text2: #8888aa;
  --text3: #44445a;
  --shadow: 0 24px 48px rgba(0,0,0,0.6);
}

/* â”€â”€â”€ LOGIN THEME TOGGLE â”€â”€â”€ */
.login-theme-toggle {
  display: flex; align-items: center; justify-content: center;
  margin-bottom: 28px;
}
.login-theme-btn {
  display: flex; align-items: center; gap: 8px;
  background: var(--bg2); border: 1.5px solid var(--border2);
  border-radius: 50px; padding: 8px 18px;
  cursor: pointer; transition: all .25s;
  font-family: 'Tajawal', sans-serif; font-size: 13px; font-weight: 700;
  color: var(--text2);
}
.login-theme-btn:hover { border-color: var(--gold); color: var(--gold); background: var(--goldfade); }
.login-theme-btn:active { transform: scale(.94); }
.login-theme-btn-icon { font-size: 17px; transition: transform .4s ease; }
.login-theme-btn:hover .login-theme-btn-icon { transform: rotate(20deg); }

/* â”€â”€â”€ LIGHT MODE â”€â”€â”€ */
body.light {
  /* Ø®Ù„ÙÙŠØ© Ø¯Ø§ÙØ¦Ø© ÙƒØ±ÙŠÙ…ÙŠØ© - Ù…Ø±ÙŠØ­Ø© Ù„Ù„Ø¹ÙŠÙ† */
  --bg: #faf7f2;
  --bg2: #f3ede4;
  --bg3: #ece5d8;
  --card: #fffdf9;
  --card2: #faf6ef;
  --border: rgba(180,150,100,0.15);
  --border2: rgba(180,150,100,0.25);
  /* Ø°Ù‡Ø¨ÙŠ Ø¯Ø§ÙƒÙ† Ø£Ù†ÙŠÙ‚ */
  --gold: #b8860b;
  --gold2: #9a7209;
  --gold3: #d4a017;
  --goldfade: rgba(184,134,11,0.1);
  /* Ø£Ù„ÙˆØ§Ù† Ù‡Ø§Ø¯Ø¦Ø© */
  --teal: #0f7c72;
  --green: #2d7d4e;
  --red: #c0392b;
  --orange: #c0621a;
  /* Ù†ØµÙˆØµ Ø¯Ø§ÙØ¦Ø© ÙˆÙ„ÙŠØ³Øª Ø¨Ø§Ø±Ø¯Ø© */
  --text: #2c2416;
  --text2: #6b5a3e;
  --text3: #a08c6e;
  --shadow: 0 8px 32px rgba(100,70,20,0.1);
}
body.light::after {
  background: radial-gradient(ellipse 80% 50% at 50% -10%, rgba(184,134,11,0.06) 0%, transparent 70%);
}
body.light .topbar {
  background: linear-gradient(var(--bg) 85%, transparent);
}
body.light .bottom-nav {
  background: rgba(250,247,242,0.95);
  border-top: 1px solid var(--border);
  backdrop-filter: blur(20px);
}
body.light .login-bg-glow {
  background: radial-gradient(circle, rgba(184,134,11,0.1) 0%, transparent 65%);
}
body.light .login-card {
  background: var(--card);
  border: 1px solid var(--border2);
  box-shadow: 0 20px 60px rgba(100,70,20,0.1), 0 0 0 1px rgba(180,150,100,0.1);
}
body.light .today-hero,
body.light .ov-card,
body.light .chart-card,
body.light .stat-box,
body.light .habit-row,
body.light .journal-textarea-wrap,
body.light .settings-card {
  background: var(--card);
  box-shadow: 0 2px 12px rgba(100,70,20,0.06);
}
body.light .tabs {
  background: var(--card);
  box-shadow: 0 2px 8px rgba(100,70,20,0.06);
}
body.light .modal-sheet {
  background: var(--card);
}
body.light .ring-fill { filter: drop-shadow(0 0 6px rgba(184,134,11,0.5)); }
body.light .login-theme-btn {
  background: var(--bg2);
}

*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html{scroll-behavior:smooth;}
body{
  font-family:'Tajawal',sans-serif;
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  overflow-x:hidden;
}
body::after{
  content:'';position:fixed;inset:0;
  background:radial-gradient(ellipse 80% 50% at 50% -10%, rgba(245,200,66,0.07) 0%, transparent 70%);
  pointer-events:none;z-index:0;
}

/* â”€â”€â”€ SCROLLBAR â”€â”€â”€ */
::-webkit-scrollbar{width:3px;}
::-webkit-scrollbar-track{background:transparent;}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#login-page{
  position:fixed;inset:0;
  display:flex;align-items:center;justify-content:center;
  background:var(--bg);z-index:200;
  transition:opacity .5s ease,transform .6s ease;
}
#login-page.out{opacity:0;transform:scale(1.06);pointer-events:none;}

.login-bg-glow{
  position:absolute;
  width:600px;height:600px;border-radius:50%;
  background:radial-gradient(circle,rgba(245,200,66,0.1) 0%,transparent 65%);
  top:50%;left:50%;transform:translate(-50%,-52%);
  animation:breathe 5s ease-in-out infinite;
}
@keyframes breathe{
  0%,100%{transform:translate(-50%,-52%) scale(1);}
  50%{transform:translate(-50%,-52%) scale(1.08);}
}

.login-card{
  position:relative;z-index:2;
  background:var(--card);
  border:1px solid var(--border2);
  border-radius:28px;
  padding:52px 40px 44px;
  width:100%;max-width:380px;
  text-align:center;
  box-shadow:var(--shadow), 0 0 100px rgba(245,200,66,0.06);
}
.login-icon{font-size:48px;margin-bottom:12px;display:block;animation:float 3s ease-in-out infinite;}
@keyframes float{0%,100%{transform:translateY(0);}50%{transform:translateY(-6px);}}
.login-app-name{
  font-family:'Cairo',sans-serif;font-size:36px;font-weight:900;
  background:linear-gradient(135deg,var(--gold) 0%,var(--teal) 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
  margin-bottom:4px;
}
.login-tagline{color:var(--text3);font-size:13px;margin-bottom:40px;}
.login-pwd-wrap{position:relative;margin-bottom:20px;}
.login-input{
  width:100%;
  background:var(--bg2);
  border:1.5px solid var(--border2);
  border-radius:14px;
  padding:15px 20px;
  color:var(--text);
  font-family:'Tajawal',sans-serif;
  font-size:22px;letter-spacing:8px;
  text-align:center;outline:none;
  transition:border-color .25s,box-shadow .25s;
}
.login-input:focus{border-color:var(--gold);box-shadow:0 0 0 4px rgba(245,200,66,0.1);}
.login-input::placeholder{letter-spacing:4px;font-size:18px;color:var(--text3);}
.login-input { margin-bottom: 0; }
.login-btn { margin-top: 20px; }
.login-btn{
  width:100%;
  background:linear-gradient(135deg,var(--gold2),var(--gold));
  border:none;border-radius:14px;
  padding:16px;
  color:#08080e;
  font-family:'Cairo',sans-serif;font-size:17px;font-weight:800;
  cursor:pointer;
  transition:transform .2s,box-shadow .2s;
  box-shadow:0 8px 28px rgba(245,200,66,0.35);
}
.login-btn:active{transform:scale(.97);}
.login-btn:hover{box-shadow:0 12px 36px rgba(245,200,66,0.45);}
.login-err{
  color:var(--red);font-size:13px;margin-top:12px;
  height:18px;transition:opacity .3s;opacity:0;
}
.login-err.show{opacity:1;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   APP SHELL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#app{
  max-width:480px;margin:0 auto;
  padding:0 16px 100px;
  position:relative;z-index:1;
}

/* â”€â”€â”€ TOP BAR â”€â”€â”€ */
.topbar{
  display:flex;align-items:center;justify-content:space-between;
  padding:20px 0 18px;
  position:sticky;top:0;
  background:linear-gradient(var(--bg) 85%,transparent);
  z-index:50;
}
.topbar-logo{
  font-family:'Cairo',sans-serif;font-size:20px;font-weight:900;
  background:linear-gradient(135deg,var(--gold),var(--teal));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.topbar-right{display:flex;align-items:center;gap:10px;}
.topbar-date{color:var(--text3);font-size:12px;font-weight:500;}
.icon-btn{
  width:36px;height:36px;border-radius:10px;
  background:var(--card);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  font-size:16px;cursor:pointer;transition:all .2s;
  color:var(--text2);
}
.icon-btn:hover{background:var(--card2);border-color:var(--border2);color:var(--text);}
.icon-btn:active{transform:scale(.92);}

/* â”€â”€â”€ TABS â”€â”€â”€ */
.tabs{
  display:flex;gap:3px;
  background:var(--card);border:1px solid var(--border);
  border-radius:16px;padding:4px;
  margin-bottom:24px;
}
.tab-btn{
  flex:1;background:none;border:none;border-radius:12px;
  padding:11px 6px;color:var(--text3);
  font-family:'Tajawal',sans-serif;font-size:13px;font-weight:700;
  cursor:pointer;transition:all .25s;
}
.tab-btn.active{
  background:linear-gradient(135deg,rgba(245,200,66,0.2),rgba(45,212,191,0.12));
  color:var(--gold);
  box-shadow:0 2px 10px rgba(0,0,0,0.3);
}
.tab-content{display:none;animation:fadeUp .3s ease;}
.tab-content.active{display:block;}
@keyframes fadeUp{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TODAY TAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.today-hero{
  background:var(--card);border:1px solid var(--border);
  border-radius:22px;padding:22px 20px;
  margin-bottom:20px;
  display:flex;align-items:center;justify-content:space-between;
  position:relative;overflow:hidden;
}
.today-hero::before{
  content:'';position:absolute;
  top:-40px;left:-40px;
  width:160px;height:160px;border-radius:50%;
  background:radial-gradient(circle,rgba(245,200,66,0.08),transparent 70%);
}
.today-hero-left{}
.today-hero-greeting{
  color:var(--text3);font-size:12px;font-weight:600;
  letter-spacing:.5px;margin-bottom:4px;
}
.today-hero-date{
  font-family:'Cairo',sans-serif;font-size:17px;font-weight:700;
  color:var(--text);margin-bottom:8px;
}
.today-hero-sub{color:var(--text2);font-size:13px;}
.today-hero-sub span{color:var(--gold);font-weight:700;}

/* Ring */
.ring-wrap{position:relative;width:72px;height:72px;flex-shrink:0;}
.ring-svg{transform:rotate(-90deg);}
.ring-bg{fill:none;stroke:var(--bg3);stroke-width:5;}
.ring-fill{
  fill:none;stroke:var(--gold);stroke-width:5;stroke-linecap:round;
  stroke-dasharray:175;stroke-dashoffset:175;
  transition:stroke-dashoffset 1.2s cubic-bezier(.4,0,.2,1);
  filter:drop-shadow(0 0 6px rgba(245,200,66,0.6));
}
.ring-label{
  position:absolute;inset:0;
  display:flex;align-items:center;justify-content:center;flex-direction:column;
}
.ring-pct{font-family:'Cairo',sans-serif;font-size:16px;font-weight:900;color:var(--gold);}
.ring-sub{font-size:9px;color:var(--text3);font-weight:600;}

/* Habits */
.habits-section-title{
  display:flex;align-items:center;justify-content:space-between;
  margin-bottom:12px;padding:0 2px;
}
.section-label{
  font-size:12px;font-weight:700;color:var(--text3);
  letter-spacing:.5px;text-transform:uppercase;
}
.habits-list{display:flex;flex-direction:column;gap:8px;}

.habit-row{
  background:var(--card);border:1px solid var(--border);
  border-radius:16px;padding:14px 16px;
  display:flex;align-items:center;gap:13px;
  cursor:pointer;
  transition:transform .15s,border-color .2s,background .2s;
  -webkit-user-select:none;user-select:none;
  position:relative;overflow:hidden;
}
.habit-row::after{
  content:'';position:absolute;inset:0;
  background:linear-gradient(135deg,rgba(245,200,66,0.06),transparent);
  opacity:0;transition:opacity .25s;border-radius:16px;
}
.habit-row:active{transform:scale(.97);}
.habit-row.done{border-color:rgba(245,200,66,0.25);}
.habit-row.done::after{opacity:1;}

.habit-emoji{font-size:22px;width:34px;text-align:center;flex-shrink:0;}
.habit-info{flex:1;min-width:0;}
.habit-name{font-size:15px;font-weight:600;color:var(--text);line-height:1.2;}
.habit-name.done-text{color:var(--text2);}
.habit-hint{font-size:11px;color:var(--text3);margin-top:2px;}

.habit-check{
  width:28px;height:28px;border-radius:9px;
  border:2px solid var(--border2);
  display:flex;align-items:center;justify-content:center;
  flex-shrink:0;
  transition:all .25s cubic-bezier(.34,1.56,.64,1);
  background:transparent;
}
.habit-row.done .habit-check{
  background:linear-gradient(135deg,var(--gold2),var(--gold));
  border-color:transparent;
  box-shadow:0 4px 14px rgba(245,200,66,0.45);
  transform:scale(1.08);
}
.check-icon{
  color:#08080e;font-size:13px;font-weight:900;
  opacity:0;transform:scale(.5);
  transition:all .2s cubic-bezier(.34,1.56,.64,1);
}
.habit-row.done .check-icon{opacity:1;transform:scale(1);}

/* Separator */
.habits-separator{
  display:flex;align-items:center;gap:10px;
  margin:14px 0 12px;
}
.habits-separator-line{flex:1;height:1px;background:var(--border);}
.habits-separator-text{color:var(--text3);font-size:11px;font-weight:600;white-space:nowrap;}

/* Add btn */
.add-habit-row{
  background:none;border:1.5px dashed var(--border2);
  border-radius:16px;padding:14px 16px;
  width:100%;
  display:flex;align-items:center;gap:12px;
  cursor:pointer;transition:all .2s;
  margin-top:4px;
  color:var(--text3);font-family:'Tajawal',sans-serif;font-size:14px;font-weight:600;
}
.add-habit-row:hover{border-color:var(--gold);color:var(--gold);background:var(--goldfade);}
.add-habit-row:active{transform:scale(.97);}
.add-plus{
  width:32px;height:32px;border-radius:9px;
  background:var(--bg3);
  display:flex;align-items:center;justify-content:center;
  font-size:20px;color:var(--text3);
  transition:all .2s;flex-shrink:0;
}
.add-habit-row:hover .add-plus{background:var(--goldfade);color:var(--gold);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OVERVIEW TAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stats-row{
  display:grid;grid-template-columns:repeat(3,1fr);
  gap:10px;margin-bottom:18px;
}
.stat-box{
  background:var(--card);border:1px solid var(--border);
  border-radius:18px;padding:16px 14px;
  text-align:center;position:relative;overflow:hidden;
  transition:transform .2s;
}
.stat-box:active{transform:scale(.97);}
.stat-box::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;border-radius:18px 18px 0 0;
}
.stat-box.s-gold::before{background:linear-gradient(90deg,var(--gold2),var(--gold3));}
.stat-box.s-teal::before{background:linear-gradient(90deg,#0d9488,var(--teal));}
.stat-box.s-green::before{background:linear-gradient(90deg,#16a34a,var(--green));}
.stat-icon{font-size:20px;margin-bottom:6px;}
.stat-val{
  font-family:'Cairo',sans-serif;font-size:26px;font-weight:900;
  line-height:1;margin-bottom:4px;
}
.stat-box.s-gold .stat-val{color:var(--gold);}
.stat-box.s-teal .stat-val{color:var(--teal);}
.stat-box.s-green .stat-val{color:var(--green);}
.stat-lbl{color:var(--text3);font-size:10px;font-weight:600;}

/* Card */
.ov-card{
  background:var(--card);border:1px solid var(--border);
  border-radius:20px;padding:20px;margin-bottom:16px;
}
.ov-card-title{
  font-size:12px;font-weight:700;color:var(--text3);
  letter-spacing:.5px;margin-bottom:16px;
  display:flex;align-items:center;gap:6px;
}
.ov-card-title::before{
  content:'';display:block;width:3px;height:13px;
  border-radius:2px;background:linear-gradient(var(--gold),var(--teal));
}

/* Week chart */
.week-bars{
  display:flex;align-items:flex-end;gap:8px;
  height:90px;
}
.wbar-wrap{flex:1;display:flex;flex-direction:column;align-items:center;gap:5px;}
.wbar{
  width:100%;border-radius:6px 6px 0 0;min-height:4px;
  transition:height .8s cubic-bezier(.34,1.56,.64,1);
}
.wbar.done{background:linear-gradient(180deg,var(--gold),var(--gold2));box-shadow:0 -4px 12px rgba(245,200,66,0.3);}
.wbar.today-bar{background:linear-gradient(180deg,var(--teal),#0d9488);box-shadow:0 -4px 12px rgba(45,212,191,0.3);}
.wbar.empty{background:var(--bg3);}
.wbar-day{color:var(--text3);font-size:10px;font-weight:700;}
.wbar-pct{color:var(--text3);font-size:9px;}

/* Habit % list */
.habit-pct-list{display:flex;flex-direction:column;gap:10px;}
.hpct-row{display:flex;align-items:center;gap:10px;}
.hpct-icon{font-size:16px;width:26px;text-align:center;flex-shrink:0;}
.hpct-name{flex:1;font-size:13px;font-weight:600;color:var(--text2);min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.hpct-bar-wrap{width:90px;height:5px;background:var(--bg3);border-radius:10px;overflow:hidden;flex-shrink:0;}
.hpct-bar{height:100%;border-radius:10px;background:linear-gradient(90deg,var(--gold2),var(--gold3));transition:width 1.2s cubic-bezier(.4,0,.2,1);}
.hpct-pct{width:32px;text-align:left;color:var(--gold);font-size:12px;font-weight:700;flex-shrink:0;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HISTORY TAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.cal-nav{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
.cal-nav-btn{
  width:34px;height:34px;border-radius:10px;
  background:var(--card);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  font-size:14px;cursor:pointer;color:var(--text2);transition:all .2s;
}
.cal-nav-btn:hover{background:var(--card2);color:var(--text);}
.cal-month-title{font-family:'Cairo',sans-serif;font-size:16px;font-weight:700;}

.cal-headers{
  display:grid;grid-template-columns:repeat(7,1fr);gap:4px;
  margin-bottom:4px;
}
.cal-hdr{text-align:center;color:var(--text3);font-size:10px;font-weight:700;padding:6px 0;}

.cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:4px;}
.cal-cell{
  aspect-ratio:1;border-radius:10px;
  display:flex;align-items:center;justify-content:center;
  font-size:12px;font-weight:700;cursor:pointer;
  transition:transform .15s;
}
.cal-cell:active{transform:scale(.9);}
.cal-cell.c-empty{background:transparent;pointer-events:none;}
.cal-cell.c-none{background:var(--bg3);color:var(--text3);}
.cal-cell.c-low{background:rgba(248,113,113,0.2);color:var(--red);}
.cal-cell.c-mid{background:rgba(251,191,36,0.18);color:#fbbf24;}
.cal-cell.c-high{background:rgba(74,222,128,0.18);color:var(--green);}
.cal-cell.c-full{background:linear-gradient(135deg,rgba(245,200,66,0.28),rgba(45,212,191,0.2));color:var(--gold3);}
.cal-cell.c-today{outline:2px solid var(--gold);outline-offset:2px;}

.cal-legend{display:flex;flex-wrap:wrap;gap:12px;margin-top:14px;}
.leg-item{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--text3);}
.leg-dot{width:10px;height:10px;border-radius:3px;}

/* Day detail panel */
.day-detail{
  background:var(--card);border:1px solid var(--border);
  border-radius:18px;padding:18px;margin-top:14px;
  display:none;
}
.day-detail.show{display:block;animation:fadeUp .25s ease;}
.day-detail-title{font-family:'Cairo',sans-serif;font-size:15px;font-weight:700;margin-bottom:14px;color:var(--gold);}
.day-detail-habits{display:flex;flex-direction:column;gap:8px;}
.ddh-row{display:flex;align-items:center;gap:10px;}
.ddh-icon{font-size:16px;width:26px;text-align:center;}
.ddh-name{flex:1;font-size:13px;font-weight:600;}
.ddh-status{font-size:14px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM NAV
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.bottom-nav{
  position:fixed;bottom:0;left:50%;transform:translateX(-50%);
  width:100%;max-width:480px;
  background:rgba(14,14,24,0.92);
  border-top:1px solid var(--border);
  backdrop-filter:blur(20px);
  display:flex;
  padding:10px 16px calc(10px + env(safe-area-inset-bottom));
  z-index:100;
}
.nav-btn{
  flex:1;background:none;border:none;
  display:flex;flex-direction:column;align-items:center;gap:4px;
  cursor:pointer;padding:6px;border-radius:12px;
  transition:all .2s;color:var(--text3);
  font-family:'Tajawal',sans-serif;font-size:10px;font-weight:700;
}
.nav-btn:active{transform:scale(.9);}
.nav-btn.active{color:var(--gold);}
.nav-icon{font-size:20px;transition:transform .2s;}
.nav-btn.active .nav-icon{transform:scale(1.1);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL: Add Habit
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.modal-overlay{
  position:fixed;inset:0;
  background:rgba(0,0,0,0.75);
  backdrop-filter:blur(10px);
  z-index:300;
  display:flex;align-items:flex-end;justify-content:center;
  opacity:0;pointer-events:none;
  transition:opacity .3s;
}
.modal-overlay.show{opacity:1;pointer-events:all;}

.modal-sheet{
  background:var(--card2);
  border:1px solid var(--border2);
  border-radius:28px 28px 0 0;
  padding:12px 20px 40px;
  width:100%;max-width:480px;
  transform:translateY(100%);
  transition:transform .35s cubic-bezier(.4,0,.2,1);
}
.modal-overlay.show .modal-sheet{transform:translateY(0);}

.modal-handle{
  width:40px;height:4px;border-radius:2px;
  background:var(--border2);margin:0 auto 20px;
}
.modal-title{
  font-family:'Cairo',sans-serif;font-size:19px;font-weight:800;
  margin-bottom:20px;
}
.form-label{
  display:block;color:var(--text3);font-size:12px;font-weight:700;
  letter-spacing:.4px;margin-bottom:6px;
}
.form-input{
  width:100%;background:var(--bg2);
  border:1.5px solid var(--border2);border-radius:12px;
  padding:13px 16px;color:var(--text);
  font-family:'Tajawal',sans-serif;font-size:15px;
  outline:none;transition:border-color .2s;
  margin-bottom:16px;
}
.form-input:focus{border-color:var(--gold);}
.form-input::placeholder{color:var(--text3);}

.icon-grid{
  display:grid;grid-template-columns:repeat(7,1fr);gap:8px;
  margin-bottom:20px;
}
.icon-cell{
  aspect-ratio:1;border-radius:10px;
  background:var(--bg3);border:2px solid transparent;
  display:flex;align-items:center;justify-content:center;
  font-size:20px;cursor:pointer;transition:all .15s;
}
.icon-cell:active{transform:scale(.88);}
.icon-cell.sel{border-color:var(--gold);background:var(--goldfade);}

.hint-input{
  width:100%;background:var(--bg2);
  border:1.5px solid var(--border2);border-radius:12px;
  padding:11px 16px;color:var(--text);
  font-family:'Tajawal',sans-serif;font-size:13px;
  outline:none;transition:border-color .2s;
  margin-bottom:20px;
}
.hint-input:focus{border-color:var(--teal);}
.hint-input::placeholder{color:var(--text3);}

.modal-actions{display:flex;gap:10px;}
.btn-add{
  flex:2;background:linear-gradient(135deg,var(--gold2),var(--gold));
  border:none;border-radius:14px;padding:15px;
  color:#08080e;font-family:'Cairo',sans-serif;font-size:16px;font-weight:800;
  cursor:pointer;box-shadow:0 8px 24px rgba(245,200,66,0.35);
  transition:all .2s;
}
.btn-add:active{transform:scale(.96);}
.btn-cancel{
  flex:1;background:none;border:1.5px solid var(--border2);
  border-radius:14px;padding:15px;
  color:var(--text2);font-family:'Tajawal',sans-serif;font-size:15px;
  cursor:pointer;transition:all .2s;
}
.btn-cancel:active{transform:scale(.96);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL: Manage Habits
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.manage-list{display:flex;flex-direction:column;gap:8px;margin-bottom:20px;max-height:55vh;overflow-y:auto;}
.manage-row{
  display:flex;align-items:center;gap:12px;
  background:var(--bg3);border-radius:12px;padding:12px 14px;
}
.manage-icon{font-size:20px;width:30px;text-align:center;}
.manage-name{flex:1;font-size:14px;font-weight:600;}
.manage-actions{display:flex;gap:6px;}
.mgmt-btn{
  width:30px;height:30px;border-radius:8px;
  background:var(--card);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;
  font-size:14px;cursor:pointer;transition:all .15s;
  color:var(--text3);
}
.mgmt-btn:active{transform:scale(.88);}
.mgmt-btn.del:hover{background:rgba(248,113,113,0.15);color:var(--red);border-color:rgba(248,113,113,0.3);}
.mgmt-btn.tog:hover{background:var(--goldfade);color:var(--gold);border-color:rgba(245,200,66,0.3);}
.manage-row.inactive{opacity:.45;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SYNC STATUS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sync-bar{
  display:flex;align-items:center;gap:6px;
  font-size:11px;color:var(--text3);
  padding:6px 0 2px;
}
.sync-dot{
  width:6px;height:6px;border-radius:50%;
  background:var(--text3);transition:background .3s;
}
.sync-dot.syncing{background:var(--gold);animation:blink .7s infinite;}
.sync-dot.synced{background:var(--green);}
.sync-dot.error{background:var(--red);}
@keyframes blink{0%,100%{opacity:1;}50%{opacity:.3;};}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.toast{
  position:fixed;top:80px;left:50%;transform:translateX(-50%) translateY(-10px);
  background:var(--card2);border:1px solid var(--border2);
  border-radius:12px;padding:10px 20px;
  font-size:13px;font-weight:600;
  opacity:0;transition:all .3s cubic-bezier(.34,1.56,.64,1);
  z-index:500;white-space:nowrap;
  box-shadow:0 8px 24px rgba(0,0,0,0.4);
}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.toast.success{color:var(--green);border-color:rgba(74,222,128,0.3);}
.toast.error{color:var(--red);border-color:rgba(248,113,113,0.3);}
.toast.info{color:var(--gold);border-color:rgba(245,200,66,0.3);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS TAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.settings-section{margin-bottom:20px;}
.settings-title{
  font-size:11px;font-weight:700;color:var(--text3);
  letter-spacing:.5px;margin-bottom:10px;padding:0 4px;
}
.settings-card{
  background:var(--card);border:1px solid var(--border);
  border-radius:18px;overflow:hidden;
}
.settings-row{
  display:flex;align-items:center;gap:12px;
  padding:14px 16px;border-bottom:1px solid var(--border);
  cursor:pointer;transition:background .15s;
}
.settings-row:last-child{border-bottom:none;}
.settings-row:active{background:var(--card2);}
.settings-row-icon{font-size:20px;width:32px;text-align:center;}
.settings-row-info{flex:1;}
.settings-row-name{font-size:14px;font-weight:600;}
.settings-row-sub{font-size:11px;color:var(--text3);margin-top:2px;}
.settings-row-arrow{color:var(--text3);font-size:14px;}

.settings-input-row{
  padding:14px 16px;border-bottom:1px solid var(--border);
}
.settings-input-row:last-child{border-bottom:none;}
.settings-input-lbl{
  font-size:11px;color:var(--text3);font-weight:700;
  letter-spacing:.3px;margin-bottom:6px;
}
.settings-input{
  width:100%;background:var(--bg3);
  border:1.5px solid var(--border);border-radius:10px;
  padding:10px 14px;color:var(--text);
  font-family:'Tajawal',sans-serif;font-size:14px;
  outline:none;transition:border-color .2s;
}
.settings-input:focus{border-color:var(--gold);}
.settings-save-btn{
  width:100%;background:linear-gradient(135deg,var(--gold2),var(--gold));
  border:none;border-radius:14px;padding:14px;
  color:#08080e;font-family:'Cairo',sans-serif;font-size:15px;font-weight:800;
  cursor:pointer;margin-top:12px;
  transition:all .2s;
  box-shadow:0 6px 20px rgba(245,200,66,0.3);
}
.settings-save-btn:active{transform:scale(.97);}

.logout-btn{
  width:100%;background:none;
  border:1.5px solid rgba(248,113,113,0.3);
  border-radius:14px;padding:14px;
  color:var(--red);font-family:'Tajawal',sans-serif;font-size:15px;font-weight:600;
  cursor:pointer;transition:all .2s;margin-top:6px;
}
.logout-btn:active{transform:scale(.97);background:rgba(248,113,113,0.1);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   JOURNAL TAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.journal-hero {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 22px; padding: 20px;
  margin-bottom: 16px;
  display: flex; align-items: center; justify-content: space-between;
}
.journal-hero-date {
  font-family: 'Cairo', sans-serif; font-size: 17px; font-weight: 700;
}
.journal-hero-sub { color: var(--text3); font-size: 12px; margin-top: 3px; }
.journal-mood-row {
  display: flex; gap: 8px; margin-bottom: 16px;
}
.mood-btn {
  flex: 1; background: var(--card); border: 1.5px solid var(--border);
  border-radius: 14px; padding: 10px 6px;
  display: flex; flex-direction: column; align-items: center; gap: 4px;
  cursor: pointer; transition: all .2s; font-size: 22px;
}
.mood-btn span { font-size: 10px; font-weight: 700; color: var(--text3); font-family: 'Tajawal', sans-serif; }
.mood-btn.selected { border-color: var(--gold); background: var(--goldfade); }
.mood-btn:active { transform: scale(.92); }

.journal-textarea-wrap {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 20px; padding: 18px;
  margin-bottom: 14px; position: relative;
}
.journal-section-lbl {
  font-size: 11px; font-weight: 700; color: var(--text3);
  letter-spacing: .5px; margin-bottom: 10px;
  display: flex; align-items: center; gap: 6px;
}
.journal-section-lbl::before {
  content: ''; display: block; width: 3px; height: 12px;
  border-radius: 2px; background: linear-gradient(var(--gold), var(--teal));
}
.journal-textarea {
  width: 100%; background: var(--bg2);
  border: 1.5px solid var(--border); border-radius: 14px;
  padding: 14px 16px; color: var(--text);
  font-family: 'Tajawal', sans-serif; font-size: 15px; line-height: 1.8;
  outline: none; resize: none; min-height: 120px;
  transition: border-color .2s;
}
.journal-textarea:focus { border-color: var(--gold); }
.journal-textarea::placeholder { color: var(--text3); }

.journal-save-btn {
  width: 100%; background: linear-gradient(135deg, var(--gold2), var(--gold));
  border: none; border-radius: 16px; padding: 16px;
  color: #08080e; font-family: 'Cairo', sans-serif; font-size: 16px; font-weight: 800;
  cursor: pointer; box-shadow: 0 8px 24px rgba(245,200,66,0.3);
  transition: all .2s; margin-bottom: 20px;
}
.journal-save-btn:active { transform: scale(.97); }

.journal-history-title {
  font-size: 12px; font-weight: 700; color: var(--text3);
  letter-spacing: .5px; margin-bottom: 12px; padding: 0 2px;
}
.journal-entries { display: flex; flex-direction: column; gap: 12px; }
.journal-entry {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 18px; padding: 16px 18px;
  cursor: pointer; transition: border-color .2s;
}
.journal-entry:hover { border-color: var(--border2); }
.journal-entry-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 8px;
}
.journal-entry-date {
  font-family: 'Cairo', sans-serif; font-size: 13px; font-weight: 700; color: var(--gold);
}
.journal-entry-mood { font-size: 18px; }
.journal-entry-preview {
  font-size: 13px; color: var(--text2); line-height: 1.6;
  overflow: hidden; display: -webkit-box;
  -webkit-line-clamp: 2; -webkit-box-orient: vertical;
}
.journal-entry-tags {
  display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap;
}
.journal-tag {
  background: var(--bg3); border-radius: 20px;
  padding: 3px 10px; font-size: 11px; font-weight: 600; color: var(--text3);
}
.journal-empty {
  text-align: center; padding: 40px 20px;
  color: var(--text3); font-size: 14px;
}
.journal-empty-icon { font-size: 40px; margin-bottom: 10px; }

/* Entry detail modal */
.entry-detail-content {
  max-height: 60vh; overflow-y: auto;
  font-size: 15px; line-height: 1.9; color: var(--text2);
  white-space: pre-wrap; margin-bottom: 16px;
}
.entry-detail-gratitude {
  background: var(--goldfade); border: 1px solid rgba(245,200,66,0.2);
  border-radius: 12px; padding: 14px; margin-bottom: 16px;
  font-size: 14px; line-height: 1.8; color: var(--text);
  white-space: pre-wrap;
}
.entry-detail-gratitude-lbl {
  font-size: 11px; font-weight: 700; color: var(--gold);
  letter-spacing: .4px; margin-bottom: 6px;
}

</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="login-page">
  <div class="login-bg-glow"></div>
  <div class="login-card">
    <span class="login-icon">ğŸŒ™</span>
    <div class="login-app-name">Ù…Ø±Ø§ÙÙ‚</div>
    <div class="login-tagline">ØªØªØ¨Ø¹ Ø¹Ø§Ø¯Ø§ØªÙƒ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</div>
    <div class="login-theme-toggle">
      <button class="login-theme-btn" id="login-theme-btn" onclick="toggleTheme()">
        <span class="login-theme-btn-icon" id="login-theme-icon">ğŸŒ™</span>
        <span id="login-theme-label">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†</span>
      </button>
    </div>
    <input class="login-input" type="password" id="pwd" placeholder="â€¢â€¢â€¢â€¢" maxlength="20" autocomplete="off" dir="ltr" inputmode="numeric">
    <button class="login-btn" onclick="doLogin()">Ø¯Ø®ÙˆÙ„ â†</button>
    <div class="login-err" id="login-err">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø© âŒ</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• APP â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="app" style="display:none">

  <div class="topbar">
    <div class="topbar-logo">Ù…Ø±Ø§ÙÙ‚ âœ¦</div>
    <div class="topbar-right">
      <div class="topbar-date" id="topbar-date"></div>
      <div class="icon-btn" id="theme-btn" onclick="toggleTheme()" title="ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø¸Ù‡Ø±">ğŸŒ™</div>
      <div class="icon-btn" onclick="openManage()" title="Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ø¯Ø§Øª">âš™</div>
    </div>
  </div>

  <!-- TABS -->
  <div class="tabs">
    <button class="tab-btn active" id="tab-btn-today" onclick="gotoTab('today',this)">Ø§Ù„ÙŠÙˆÙ…</button>
    <button class="tab-btn" id="tab-btn-overview" onclick="gotoTab('overview',this)">Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
    <button class="tab-btn" id="tab-btn-history" onclick="gotoTab('history',this)">Ø§Ù„Ø³Ø¬Ù„</button>
    <button class="tab-btn" id="tab-btn-journal" onclick="gotoTab('journal',this)">Ù…Ø°ÙƒØ±Ø©</button>
    <button class="tab-btn" id="tab-btn-settings" onclick="gotoTab('settings',this)">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
  </div>

  <!-- â•â• TODAY â•â• -->
  <div class="tab-content active" id="tab-today">
    <div class="today-hero">
      <div class="today-hero-left">
        <div class="today-hero-greeting">Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ± ğŸ‘‹</div>
        <div class="today-hero-date" id="today-date-hero"></div>
        <div class="today-hero-sub">
          Ø£Ù†Ø¬Ø²Øª <span id="hero-done">0</span> Ù…Ù† <span id="hero-total">0</span> Ø¹Ø§Ø¯Ø©
        </div>
      </div>
      <div class="ring-wrap">
        <svg class="ring-svg" viewBox="0 0 60 60" width="72" height="72">
          <circle class="ring-bg" cx="30" cy="30" r="27.5"/>
          <circle class="ring-fill" id="ring-fill" cx="30" cy="30" r="27.5"/>
        </svg>
        <div class="ring-label">
          <div class="ring-pct" id="ring-pct">0%</div>
          <div class="ring-sub">Ø§Ù„ÙŠÙˆÙ…</div>
        </div>
      </div>
    </div>

    <div class="sync-bar">
      <div class="sync-dot" id="sync-dot"></div>
      <span id="sync-label">Ù…Ø­Ù„ÙŠ</span>
    </div>

    <div class="habits-section-title">
      <div class="section-label">Ø¹Ø§Ø¯Ø§ØªÙƒ Ø§Ù„ÙŠÙˆÙ…</div>
    </div>

    <div class="habits-list" id="habits-list"></div>

    <button class="add-habit-row" onclick="openAddModal()">
      <div class="add-plus">ï¼‹</div>
      <span>Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</span>
    </button>
  </div>

  <!-- â•â• OVERVIEW â•â• -->
  <div class="tab-content" id="tab-overview">
    <div class="stats-row">
      <div class="stat-box s-gold">
        <div class="stat-icon">ğŸ“Š</div>
        <div class="stat-val" id="ov-week">0%</div>
        <div class="stat-lbl">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>
      </div>
      <div class="stat-box s-teal">
        <div class="stat-icon">ğŸ”¥</div>
        <div class="stat-val" id="ov-streak">0</div>
        <div class="stat-lbl">Ø§Ù„Ø³Ù„Ø³Ù„Ø©</div>
      </div>
      <div class="stat-box s-green">
        <div class="stat-icon">ğŸ†</div>
        <div class="stat-val" id="ov-best">0</div>
        <div class="stat-lbl">Ø§Ù„Ø£ÙØ¶Ù„</div>
      </div>
    </div>

    <div class="ov-card">
      <div class="ov-card-title">Ø§Ù„ØªÙ‚Ø¯Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ</div>
      <div class="week-bars" id="week-bars"></div>
    </div>

    <div class="ov-card">
      <div class="ov-card-title">Ø¥Ù†Ø¬Ø§Ø² ÙƒÙ„ Ø¹Ø§Ø¯Ø©</div>
      <div class="habit-pct-list" id="habit-pct-list"></div>
    </div>
  </div>

  <!-- â•â• HISTORY â•â• -->
  <div class="tab-content" id="tab-history">
    <div class="ov-card">
      <div class="cal-nav">
        <button class="cal-nav-btn" onclick="calPrev()">â€º</button>
        <div class="cal-month-title" id="cal-title"></div>
        <button class="cal-nav-btn" onclick="calNext()">â€¹</button>
      </div>
      <div class="cal-headers" id="cal-headers"></div>
      <div class="cal-grid" id="cal-grid"></div>
      <div class="cal-legend">
        <div class="leg-item"><div class="leg-dot" style="background:rgba(248,113,113,0.4)"></div>Ø£Ù‚Ù„ 50%</div>
        <div class="leg-item"><div class="leg-dot" style="background:rgba(251,191,36,0.35)"></div>50â€“79%</div>
        <div class="leg-item"><div class="leg-dot" style="background:rgba(74,222,128,0.3)"></div>80â€“99%</div>
        <div class="leg-item"><div class="leg-dot" style="background:linear-gradient(135deg,rgba(245,200,66,0.4),rgba(45,212,191,0.3))"></div>100% âœ¨</div>
      </div>
    </div>
    <div class="day-detail" id="day-detail">
      <div class="day-detail-title" id="day-detail-title"></div>
      <div class="day-detail-habits" id="day-detail-habits"></div>
    </div>
  </div>


  <!-- â•â• JOURNAL â•â• -->
  <div class="tab-content" id="tab-journal">

    <div class="journal-hero">
      <div>
        <div class="journal-hero-date" id="journal-today-date"></div>
        <div class="journal-hero-sub">Ø³Ø¬Ù‘Ù„ ÙŠÙˆÙ…Ùƒ ğŸ“”</div>
      </div>
      <div style="font-size:36px;">ğŸ“”</div>
    </div>

    <!-- Mood -->
    <div class="journal-mood-row" id="mood-row">
      <div class="mood-btn" data-mood="5" onclick="selectMood(5,this)">ğŸ˜„<span>Ù…Ù…ØªØ§Ø²</span></div>
      <div class="mood-btn" data-mood="4" onclick="selectMood(4,this)">ğŸ™‚<span>Ø¬ÙŠØ¯</span></div>
      <div class="mood-btn" data-mood="3" onclick="selectMood(3,this)">ğŸ˜<span>Ø¹Ø§Ø¯ÙŠ</span></div>
      <div class="mood-btn" data-mood="2" onclick="selectMood(2,this)">ğŸ˜”<span>ØªØ¹Ø¨Ø§Ù†</span></div>
      <div class="mood-btn" data-mood="1" onclick="selectMood(1,this)">ğŸ˜¤<span>Ø³ÙŠØ¡</span></div>
    </div>

    <!-- Gratitude -->
    <div class="journal-textarea-wrap">
      <div class="journal-section-lbl">âœ¨ Ø´ÙƒØ± ÙˆØ§Ù…ØªÙ†Ø§Ù†</div>
      <textarea class="journal-textarea" id="journal-gratitude" placeholder="Ø§ÙƒØªØ¨ 3 Ø£Ø´ÙŠØ§Ø¡ ØªØ´ÙƒØ± Ø¹Ù„ÙŠÙ‡Ø§ Ø§Ù„ÙŠÙˆÙ…..." rows="3"></textarea>
    </div>

    <!-- Free note -->
    <div class="journal-textarea-wrap">
      <div class="journal-section-lbl">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
      <textarea class="journal-textarea" id="journal-note" placeholder="Ø§ÙƒØªØ¨ Ø£ÙŠ Ø´ÙŠ ÙŠØ®Ø·Ø± Ø¹Ù„Ù‰ Ø¨Ø§Ù„Ùƒ... Ø£Ø­Ø¯Ø§Ø«ØŒ Ø£ÙÙƒØ§Ø±ØŒ Ø°ÙƒØ±ÙŠØ§Øª" rows="5"></textarea>
    </div>

    <button class="journal-save-btn" onclick="saveJournalEntry()">ğŸ’¾ Ø­ÙØ¸ ÙŠÙˆÙ… Ø§Ù„ÙŠÙˆÙ…</button>

    <!-- Past entries -->
    <div class="journal-history-title">Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>
    <div class="journal-entries" id="journal-entries"></div>

  </div>

  <!-- â•â• SETTINGS â•â• -->
  <div class="tab-content" id="tab-settings">

    <div class="settings-section">
      <div class="settings-title">Ø§Ù„Ù…Ø¸Ù‡Ø±</div>
      <div class="settings-card">
        <div class="settings-row" onclick="toggleTheme()" style="cursor:pointer;">
          <div class="settings-row-icon" id="settings-theme-icon">ğŸŒ™</div>
          <div class="settings-row-info">
            <div class="settings-row-name" id="settings-theme-name">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†</div>
            <div class="settings-row-sub">Ø§Ø¶ØºØ· Ù„Ù„ØªØ¨Ø¯ÙŠÙ„</div>
          </div>
          <div class="settings-row-arrow" id="settings-theme-toggle" style="font-size:22px;">â—</div>
        </div>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-title">Ø±Ø¨Ø· Google Sheets</div>
      <div class="settings-card">
        <div class="settings-input-row">
          <div class="settings-input-lbl">Ø±Ø§Ø¨Ø· Apps Script (Web App URL)</div>
          <input class="settings-input" type="url" id="script-url" placeholder="https://script.google.com/macros/s/..." dir="ltr">
        </div>
      </div>
      <button class="settings-save-btn" onclick="saveScriptUrl()">ğŸ’¾ Ø­ÙØ¸ ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©</button>
    </div>

    <div class="settings-section">
      <div class="settings-title">Ø§Ù„Ø£Ù…Ø§Ù†</div>
      <div class="settings-card">
        <div class="settings-input-row">
          <div class="settings-input-lbl">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ©</div>
          <input class="settings-input" type="password" id="old-pwd" placeholder="â€¢â€¢â€¢â€¢">
        </div>
        <div class="settings-input-row">
          <div class="settings-input-lbl">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</div>
          <input class="settings-input" type="password" id="new-pwd" placeholder="â€¢â€¢â€¢â€¢">
        </div>
      </div>
      <button class="settings-save-btn" onclick="changePwd()">ğŸ” ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
    </div>

    <div class="settings-section">
      <div class="settings-title">Ø§Ù„Ø­Ø³Ø§Ø¨</div>
      <button class="logout-btn" onclick="doLogout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
    </div>

    <div style="text-align:center;color:var(--text3);font-size:11px;margin-top:20px;padding-bottom:10px;">
      Ù…Ø±Ø§ÙÙ‚ v2.0 â€” Ø¨ÙÙ†ÙŠ Ø¨Ù€ â¤ï¸
    </div>
  </div>

</div><!-- end #app -->

<!-- â•â• BOTTOM NAV â•â• -->
<div class="bottom-nav" id="bottom-nav" style="display:none">
  <button class="nav-btn active" id="nav-today" onclick="gotoTab('today',null,'today')">
    <span class="nav-icon">â˜€ï¸</span>Ø§Ù„ÙŠÙˆÙ…
  </button>
  <button class="nav-btn" id="nav-overview" onclick="gotoTab('overview',null,'overview')">
    <span class="nav-icon">ğŸ“Š</span>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  </button>
  <button class="nav-btn" id="nav-history" onclick="gotoTab('history',null,'history')">
    <span class="nav-icon">ğŸ“…</span>Ø§Ù„Ø³Ø¬Ù„
  </button>
  <button class="nav-btn" id="nav-journal" onclick="gotoTab('journal',null,'journal')">
    <span class="nav-icon">ğŸ“”</span>Ù…Ø°ÙƒØ±Ø©
  </button>
  <button class="nav-btn" id="nav-settings" onclick="gotoTab('settings',null,'settings')">
    <span class="nav-icon">âš™ï¸</span>Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª
  </button>
</div>

<!-- â•â• MODAL: Add Habit â•â• -->
<div class="modal-overlay" id="add-modal" onclick="closeAddIfBg(event)">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø© âœ¨</div>
    <label class="form-label">Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¯Ø©</label>
    <input class="form-input" type="text" id="new-name" placeholder="Ù…Ø«Ø§Ù„: ØªÙ…Ø±ÙŠÙ† Ø§Ù„ØµØ¨Ø§Ø­">
    <label class="form-label">ÙˆØµÙ Ù…Ø®ØªØµØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
    <input class="hint-input" type="text" id="new-hint" placeholder="Ù…Ø«Ø§Ù„: 20 Ø¯Ù‚ÙŠÙ‚Ø©">
    <label class="form-label">Ø£ÙŠÙ‚ÙˆÙ†Ø©</label>
    <div class="icon-grid" id="icon-grid"></div>
    <div class="modal-actions">
      <button class="btn-add" onclick="confirmAddHabit()">Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø§Ø¯Ø©</button>
      <button class="btn-cancel" onclick="closeAddModal()">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>
</div>

<!-- â•â• MODAL: Manage Habits â•â• -->
<div class="modal-overlay" id="manage-modal" onclick="closeMngIfBg(event)">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div class="modal-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ø¯Ø§Øª âš™ï¸</div>
    <div class="manage-list" id="manage-list"></div>
    <button class="btn-cancel" style="width:100%;border-radius:14px;padding:14px;" onclick="closeManage()">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
</div>


<!-- â•â• MODAL: View Journal Entry â•â• -->
<div class="modal-overlay" id="entry-modal" onclick="closeEntryIfBg(event)">
  <div class="modal-sheet">
    <div class="modal-handle"></div>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
      <div class="modal-title" id="entry-modal-date" style="margin-bottom:0;font-size:17px;"></div>
      <div style="font-size:28px;" id="entry-modal-mood"></div>
    </div>
    <div id="entry-gratitude-section">
      <div class="entry-detail-gratitude-lbl">âœ¨ Ø´ÙƒØ± ÙˆØ§Ù…ØªÙ†Ø§Ù†</div>
      <div class="entry-detail-gratitude" id="entry-modal-gratitude"></div>
    </div>
    <div id="entry-note-section">
      <div class="journal-section-lbl" style="margin-bottom:8px;">ğŸ“ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙŠÙˆÙ…</div>
      <div class="entry-detail-content" id="entry-modal-note"></div>
    </div>
    <button class="btn-cancel" style="width:100%;border-radius:14px;padding:14px;" onclick="closeEntryModal()">Ø¥ØºÙ„Ø§Ù‚</button>
  </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG & STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
// ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø«Ø§Ø¨ØªØ© ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ - Ù„Ø§ ØªØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ localStorage
const DEFAULT_PWD = '2005';
const SUPABASE_URL = 'https://orziywbeccpzsnfkxrae.supabase.co';
const SUPABASE_KEY = 'sb_publishable_yhcefCaM9R3FA-BawiclaA_bjSaWXeL';
let CFG = { pwd: DEFAULT_PWD, scriptUrl: SUPABASE_URL };
try {
  const saved = JSON.parse(localStorage.getItem('cfg') || '{}');
} catch(e) {}

const DEFAULT_HABITS = [
  {id:1, name:'Ø§Ù„ØµÙ„Ø§Ø© ÙÙŠ ÙˆÙ‚ØªÙ‡Ø§',          icon:'ğŸ•Œ', hint:'Ø§Ù„ØµÙ„ÙˆØ§Øª Ø§Ù„Ø®Ù…Ø³',         active:true},
  {id:2, name:'Ø§Ù„Ù†ÙˆÙ… 7-8 Ø³Ø§Ø¹Ø§Øª',          icon:'ğŸ˜´', hint:'Ù†ÙˆÙ… Ù…Ù†ØªØ¸Ù…',              active:true},
  {id:3, name:'Ø¨Ø¯ÙˆÙ† Ù‡Ø§ØªÙ Ø£ÙˆÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø©',  icon:'ğŸ“µ', hint:'Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸ Ù…Ø¨Ø§Ø´Ø±Ø©',   active:true},
  {id:4, name:'Ø§Ù„ØªØ®Ø·ÙŠØ· Ù„Ù„ÙŠÙˆÙ…',            icon:'ğŸ“‹', hint:'Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ† ÙƒØ§ÙÙŠØªÙŠÙ†',         active:true},
  {id:5, name:'Ù…Ø´ÙŠ 15 Ø¯Ù‚ÙŠÙ‚Ø©',            icon:'ğŸš¶', hint:'Ø£ÙŠ ÙˆÙ‚Øª Ù…Ù† Ø§Ù„ÙŠÙˆÙ…',         active:true},
  {id:6, name:'Ø´Ø±Ø¨ 8 ÙƒØ§Ø³Ø§Øª Ù…Ø§Ø¡',         icon:'ğŸ’§', hint:'2 Ù„ØªØ± ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹',           active:true},
  {id:7, name:'ØªØ¹Ù„Ù… 30-40 Ø¯Ù‚ÙŠÙ‚Ø©',        icon:'ğŸ“š', hint:'ÙƒÙˆØ±Ø³ Ø£Ùˆ Ù…Ù‡Ø§Ø±Ø© Ø¬Ø¯ÙŠØ¯Ø©',     active:true},
  {id:8, name:'Ø§Ù„Ø¹Ù…Ù„ Ø¹Ù„Ù‰ 3mcars',         icon:'ğŸš—', hint:'30 Ø¯Ù‚ÙŠÙ‚Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹',         active:true},
  {id:9, name:'Ù‚Ø±Ø§Ø¡Ø© ÙƒØªØ§Ø¨',              icon:'ğŸ“–', hint:'20 Ø¯Ù‚ÙŠÙ‚Ø©',                active:true},
  {id:10,name:'Ù‚Ø±Ø§Ø¡Ø© ØµÙØ­Ø© Ù‚Ø±Ø¢Ù†',         icon:'ğŸŒŸ', hint:'ÙƒÙ„ ÙŠÙˆÙ… Ø¨Ø¯ÙˆÙ† Ø§Ø³ØªØ«Ù†Ø§Ø¡',     active:true},
  {id:11,name:'ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ„Ø§Ù… Ø§Ù„Ø²Ø§Ø¦Ø¯',      icon:'ğŸ¤', hint:'Ø§Ù†ØªØ¨Ù‡ Ù„Ù…Ø§ ØªÙ‚ÙˆÙ„',          active:true},
  {id:12,name:'ØªØ±Ùƒ Ø§Ù„Ø¹Ø§Ø¯Ø© Ø§Ù„Ø³ÙŠØ¦Ø©',        icon:'ğŸš«', hint:'Ø§Ù„ØªØ²Ø§Ù… ÙŠÙˆÙ…ÙŠ',             active:true},
];

let habits = JSON.parse(localStorage.getItem('habits2') || 'null') || JSON.parse(JSON.stringify(DEFAULT_HABITS));
let logs   = JSON.parse(localStorage.getItem('logs2')   || 'null') || buildSampleLogs();

function buildSampleLogs() {
  const d = {};
  const today = dateStr(new Date());
  for(let i=1;i<=25;i++){
    const dt=new Date(); dt.setDate(dt.getDate()-i);
    const ds=dateStr(dt);
    d[ds]={};
    DEFAULT_HABITS.forEach(h=>{
      d[ds][h.id] = Math.random() > (i>14?.55:.35) ? 1:0;
    });
  }
  d[today] = {};
  return d;
}

const TODAY = dateStr(new Date());
let calYear, calMonth;
const now = new Date();
calYear = now.getFullYear();
calMonth = now.getMonth();
let selectedIcon = 'â­';

function dateStr(d){ return d.toISOString().split('T')[0]; }
function save(){
  localStorage.setItem('habits2', JSON.stringify(habits));
  localStorage.setItem('logs2',   JSON.stringify(logs));
  localStorage.setItem('cfg',     JSON.stringify({scriptUrl: CFG.scriptUrl}));
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   LOGIN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEME
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function applyTheme(mode) {
  const isLight = mode === 'light';
  if (isLight) {
    document.body.classList.add('light');
  } else {
    document.body.classList.remove('light');
  }
  // Topbar btn
  const tb = document.getElementById('theme-btn');
  if(tb) tb.textContent = isLight ? 'â˜€ï¸' : 'ğŸŒ™';
  // Settings
  const si = document.getElementById('settings-theme-icon');
  const sn = document.getElementById('settings-theme-name');
  const st = document.getElementById('settings-theme-toggle');
  if(si) si.textContent = isLight ? 'â˜€ï¸' : 'ğŸŒ™';
  if(sn) sn.textContent = isLight ? 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­' : 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†';
  if(st) { st.textContent = 'â—'; st.style.color = isLight ? 'var(--gold)' : 'var(--text3)'; }
  // Login toggle
  const li = document.getElementById('login-theme-icon');
  const ll = document.getElementById('login-theme-label');
  if(li) li.textContent = isLight ? 'â˜€ï¸' : 'ğŸŒ™';
  if(ll) ll.textContent = isLight ? 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„ÙØ§ØªØ­' : 'Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø¯Ø§ÙƒÙ†';
}

function toggleTheme() {
  const isLight = document.body.classList.contains('light');
  const newMode = isLight ? 'dark' : 'light';
  localStorage.setItem('theme', newMode);
  applyTheme(newMode);
}

// Apply saved theme immediately
(function() {
  const saved = localStorage.getItem('theme') || 'dark';
  if (saved === 'light') document.body.classList.add('light');
})();

document.getElementById('pwd').addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();});
function doLogin(){
  const entered = document.getElementById('pwd').value.trim();
  if(entered === '2005'){
    document.getElementById('login-page').classList.add('out');
    document.getElementById('app').style.display='block';
    document.getElementById('bottom-nav').style.display='flex';
    setTimeout(()=>{
      document.getElementById('login-page').style.display='none';
    },600);
    initApp();
  } else {
    const err=document.getElementById('login-err');
    err.classList.add('show');
    document.getElementById('pwd').value='';
    setTimeout(()=>err.classList.remove('show'),2500);
  }
}
function doLogout(){
  document.getElementById('login-page').style.display='flex';
  document.getElementById('login-page').classList.remove('out');
  document.getElementById('app').style.display='none';
  document.getElementById('bottom-nav').style.display='none';
  document.getElementById('pwd').value='';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function initApp(){
  setDateLabels();
  renderToday();
  renderOverview();
  renderCalendar();
  loadSettingsUI();
  initJournal();
  syncFromSheet();
}

function setDateLabels(){
  const opts={weekday:'long',year:'numeric',month:'long',day:'numeric'};
  const ds=new Date().toLocaleDateString('ar-SA',opts);
  document.getElementById('topbar-date').textContent=new Date().toLocaleDateString('ar-SA',{month:'short',day:'numeric'});
  document.getElementById('today-date-hero').textContent=ds;
  const hr=new Date().getHours();
  const greet = hr<12?'ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ±':hr<18?'Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ±':'Ù…Ø³Ø§Ø¡ Ø§Ù„Ù†ÙˆØ±';
  document.querySelector('.today-hero-greeting').textContent=(hr<12?'ØµØ¨Ø§Ø­ Ø§Ù„Ø®ÙŠØ± ğŸŒ…':hr<17?'Ù…Ø±Ø­Ø¨Ø§Ù‹ â˜€ï¸':'Ù…Ø³Ø§Ø¡ Ø§Ù„Ø®ÙŠØ± ğŸŒ™')+' ğŸ‘‹';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function gotoTab(name, btn, navId){
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));

  if(btn) btn.classList.add('active');
  const tabBtn=document.getElementById('tab-btn-'+name);
  if(tabBtn) tabBtn.classList.add('active');
  document.getElementById('tab-'+name).classList.add('active');

  const navBtn=document.getElementById('nav-'+(navId||name));
  if(navBtn) navBtn.classList.add('active');

  if(name==='overview') renderOverview();
  if(name==='history')  renderCalendar();
  if(name==='journal')  initJournal();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TODAY TAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderToday(){
  if(!logs[TODAY]) logs[TODAY]={};
  const active=habits.filter(h=>h.active);
  const el=document.getElementById('habits-list');
  el.innerHTML='';

  // Default habits
  const defaults=active.filter(h=>h.id<=12);
  const custom=active.filter(h=>h.id>12);

  defaults.forEach(h=>el.appendChild(buildHabitRow(h)));

  if(custom.length){
    el.insertAdjacentHTML('beforeend',`
      <div class="habits-separator">
        <div class="habits-separator-line"></div>
        <div class="habits-separator-text">Ø¹Ø§Ø¯Ø§Øª Ù…Ø¶Ø§ÙØ©</div>
        <div class="habits-separator-line"></div>
      </div>`);
    custom.forEach(h=>el.appendChild(buildHabitRow(h)));
  }
  updateProgress();
}

function buildHabitRow(h){
  const done=!!(logs[TODAY]&&logs[TODAY][h.id]);
  const div=document.createElement('div');
  div.className='habit-row'+(done?' done':'');
  div.id='hr-'+h.id;
  div.innerHTML=`
    <div class="habit-emoji">${h.icon}</div>
    <div class="habit-info">
      <div class="habit-name${done?' done-text':''}" id="hn-${h.id}">${h.name}</div>
      ${h.hint?`<div class="habit-hint">${h.hint}</div>`:''}
    </div>
    <div class="habit-check" id="hc-${h.id}">
      <span class="check-icon">âœ“</span>
    </div>`;
  div.onclick=()=>toggleHabit(h.id);
  return div;
}

function toggleHabit(id){
  if(!logs[TODAY]) logs[TODAY]={};
  const newVal = logs[TODAY][id] ? 0 : 1;
  logs[TODAY][id]=newVal;

  const row=document.getElementById('hr-'+id);
  const name=document.getElementById('hn-'+id);
  if(newVal){
    row.classList.add('done');
    if(name) name.classList.add('done-text');
  } else {
    row.classList.remove('done');
    if(name) name.classList.remove('done-text');
  }
  save();
  updateProgress();
  if(CFG.scriptUrl) syncToSheet(id, newVal);
  else showToast('âœ“ ØªÙ… Ø§Ù„Ø­ÙØ¸ Ù…Ø­Ù„ÙŠØ§Ù‹','success');
}

function updateProgress(){
  const active=habits.filter(h=>h.active);
  const done=active.filter(h=>logs[TODAY]&&logs[TODAY][h.id]).length;
  const total=active.length;
  const pct=total>0?Math.round(done/total*100):0;

  document.getElementById('hero-done').textContent=done;
  document.getElementById('hero-total').textContent=total;
  document.getElementById('ring-pct').textContent=pct+'%';

  const circ=2*Math.PI*27.5;
  const offset=circ-(pct/100*circ);
  document.getElementById('ring-fill').style.strokeDasharray=circ;
  document.getElementById('ring-fill').style.strokeDashoffset=offset;

  // Color ring based on progress
  const fillEl=document.getElementById('ring-fill');
  if(pct===100) fillEl.style.stroke='var(--green)';
  else if(pct>=70) fillEl.style.stroke='var(--gold)';
  else if(pct>=40) fillEl.style.stroke='var(--orange)';
  else fillEl.style.stroke='var(--teal)';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   OVERVIEW TAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function renderOverview(){
  const active=habits.filter(h=>h.active);

  // Week data
  const arabDays=['Ø£Ø­Ø¯','Ø§Ø«Ù†','Ø«Ù„Ø§','Ø£Ø±Ø¨','Ø®Ù…Ø³','Ø¬Ù…Ø¹','Ø³Ø¨Øª'];
  const weekData=[];
  for(let i=6;i>=0;i--){
    const d=new Date(); d.setDate(d.getDate()-i);
    const ds=dateStr(d);
    const log=logs[ds]||{};
    const done=active.filter(h=>log[h.id]).length;
    const total=active.length;
    const pct=total>0?Math.round(done/total*100):0;
    weekData.push({ds,pct,day:arabDays[d.getDay()],isToday:i===0});
  }
  const avgWeek=Math.round(weekData.reduce((s,d)=>s+d.pct,0)/7);
  document.getElementById('ov-week').textContent=avgWeek+'%';

  // Streak
  let streak=0;
  for(let i=0;i<120;i++){
    const d=new Date(); d.setDate(d.getDate()-i);
    const ds=dateStr(d);
    const log=logs[ds]||{};
    const done=active.filter(h=>log[h.id]).length;
    if(done>=1) streak++; else break;
  }
  // Best streak
  let best=0,cur=0;
  Object.keys(logs).sort().forEach(ds=>{
    const log=logs[ds]; const done=active.filter(h=>log[h.id]).length;
    if(done>=1){cur++;best=Math.max(best,cur);}else cur=0;
  });
  document.getElementById('ov-streak').textContent=streak;
  document.getElementById('ov-best').textContent=Math.max(best,streak);

  // Week bars
  const barsEl=document.getElementById('week-bars');
  barsEl.innerHTML='';
  const maxH=78;
  weekData.forEach(d=>{
    const h=Math.max(4,Math.round(d.pct/100*maxH));
    const cls=d.isToday?'today-bar':d.pct>0?'done':'empty';
    barsEl.innerHTML+=`
      <div class="wbar-wrap">
        <div class="wbar ${cls}" style="height:${h}px"></div>
        <div class="wbar-day">${d.day}</div>
        <div class="wbar-pct">${d.pct}%</div>
      </div>`;
  });

  // Per-habit %
  const listEl=document.getElementById('habit-pct-list');
  listEl.innerHTML='';
  const totalDays=Object.keys(logs).length||1;
  active.forEach(h=>{
    const done=Object.values(logs).filter(l=>l[h.id]).length;
    const pct=Math.round(done/totalDays*100);
    listEl.innerHTML+=`
      <div class="hpct-row">
        <div class="hpct-icon">${h.icon}</div>
        <div class="hpct-name">${h.name}</div>
        <div class="hpct-bar-wrap">
          <div class="hpct-bar" style="width:0%" data-w="${pct}%"></div>
        </div>
        <div class="hpct-pct">${pct}%</div>
      </div>`;
  });
  requestAnimationFrame(()=>{
    document.querySelectorAll('.hpct-bar').forEach(b=>{b.style.width=b.dataset.w;});
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HISTORY / CALENDAR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const MONTHS=['ÙŠÙ†Ø§ÙŠØ±','ÙØ¨Ø±Ø§ÙŠØ±','Ù…Ø§Ø±Ø³','Ø£Ø¨Ø±ÙŠÙ„','Ù…Ø§ÙŠÙˆ','ÙŠÙˆÙ†ÙŠÙˆ','ÙŠÙˆÙ„ÙŠÙˆ','Ø£ØºØ³Ø·Ø³','Ø³Ø¨ØªÙ…Ø¨Ø±','Ø£ÙƒØªÙˆØ¨Ø±','Ù†ÙˆÙÙ…Ø¨Ø±','Ø¯ÙŠØ³Ù…Ø¨Ø±'];
const DAYS_AR=['Ø£Ø­Ø¯','Ø§Ø«Ù†','Ø«Ù„Ø§','Ø£Ø±Ø¨','Ø®Ù…Ø³','Ø¬Ù…Ø¹','Ø³Ø¨Øª'];

function renderCalendar(){
  document.getElementById('cal-title').textContent=`${MONTHS[calMonth]} ${calYear}`;
  document.getElementById('cal-headers').innerHTML=DAYS_AR.map(d=>`<div class="cal-hdr">${d}</div>`).join('');

  const active=habits.filter(h=>h.active);
  const first=new Date(calYear,calMonth,1).getDay();
  const days=new Date(calYear,calMonth+1,0).getDate();
  let html='';
  for(let i=0;i<first;i++) html+=`<div class="cal-cell c-empty"></div>`;
  for(let d=1;d<=days;d++){
    const ds=`${calYear}-${String(calMonth+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    const log=logs[ds];
    let cls='c-none';
    if(log&&active.length){
      const done=active.filter(h=>log[h.id]).length;
      const pct=done/active.length*100;
      cls=pct===100?'c-full':pct>=80?'c-high':pct>=50?'c-mid':pct>0?'c-low':'c-none';
    }
    const todayCls=ds===TODAY?' c-today':'';
    html+=`<div class="cal-cell ${cls}${todayCls}" onclick="showDayDetail('${ds}',${d})">${d}</div>`;
  }
  document.getElementById('cal-grid').innerHTML=html;
}
function calPrev(){if(calMonth===0){calMonth=11;calYear--;}else calMonth--;renderCalendar();}
function calNext(){if(calMonth===11){calMonth=0;calYear++;}else calMonth++;renderCalendar();}

function showDayDetail(ds, d){
  const active=habits.filter(h=>h.active);
  const log=logs[ds]||{};
  const detailEl=document.getElementById('day-detail');
  const titleEl=document.getElementById('day-detail-title');
  const habitsEl=document.getElementById('day-detail-habits');

  titleEl.textContent=`${MONTHS[calMonth]} ${d}ØŒ ${calYear}`;
  habitsEl.innerHTML='';
  active.forEach(h=>{
    habitsEl.innerHTML+=`
      <div class="ddh-row">
        <div class="ddh-icon">${h.icon}</div>
        <div class="ddh-name">${h.name}</div>
        <div class="ddh-status">${log[h.id]?'âœ…':'âŒ'}</div>
      </div>`;
  });
  detailEl.classList.add('show');
  detailEl.scrollIntoView({behavior:'smooth',block:'nearest'});
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ADD HABIT MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const ICONS=['â­','ğŸ’«','ğŸ¯','ğŸ”¥','ğŸ’ª','ğŸ§ ','â¤ï¸','ğŸŒ¿','â˜€ï¸','ğŸŒ™','ğŸµ','ğŸ¨','âœï¸','ğŸ“–','ğŸ“š','ğŸ’§','ğŸ','ğŸ¥—','ğŸƒ','ğŸš¶','ğŸ§˜','ğŸ›ï¸','ğŸ’Š','ğŸŒŠ','ğŸ¸','ğŸ’»','ğŸ“','ğŸŒº','ğŸ¦‹','ğŸ•Šï¸','ğŸ†','âš¡'];

function openAddModal(){
  selectedIcon=ICONS[0];
  document.getElementById('new-name').value='';
  document.getElementById('new-hint').value='';
  const grid=document.getElementById('icon-grid');
  grid.innerHTML=ICONS.map((ic,i)=>`<div class="icon-cell${i===0?' sel':''}" onclick="selIcon('${ic}',this)">${ic}</div>`).join('');
  document.getElementById('add-modal').classList.add('show');
  setTimeout(()=>document.getElementById('new-name').focus(),300);
}
function closeAddModal(){document.getElementById('add-modal').classList.remove('show');}
function closeAddIfBg(e){if(e.target===document.getElementById('add-modal'))closeAddModal();}
function selIcon(ic,el){
  selectedIcon=ic;
  document.querySelectorAll('.icon-cell').forEach(c=>c.classList.remove('sel'));
  el.classList.add('sel');
}

function confirmAddHabit(){
  const name=document.getElementById('new-name').value.trim();
  if(!name){showToast('Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ø¹Ø§Ø¯Ø© Ø£ÙˆÙ„Ø§Ù‹','error');return;}
  const hint=document.getElementById('new-hint').value.trim();
  const id=Date.now();
  const h={id, name, icon:selectedIcon, hint, active:true};
  habits.push(h);
  if(!logs[TODAY]) logs[TODAY]={};
  save();
  closeAddModal();
  renderToday();
  renderOverview();
  showToast(`âœ¨ ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© "${name}"`,'info');
  if(CFG.scriptUrl) syncHabitToSheet(h);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MANAGE HABITS MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openManage(){
  renderManageList();
  document.getElementById('manage-modal').classList.add('show');
}
function closeManage(){document.getElementById('manage-modal').classList.remove('show');}
function closeMngIfBg(e){if(e.target===document.getElementById('manage-modal'))closeManage();}

function renderManageList(){
  const el=document.getElementById('manage-list');
  el.innerHTML='';
  habits.forEach(h=>{
    const row=document.createElement('div');
    row.className='manage-row'+(h.active?'':' inactive');
    row.innerHTML=`
      <div class="manage-icon">${h.icon}</div>
      <div class="manage-name">${h.name}</div>
      <div class="manage-actions">
        <div class="mgmt-btn tog" onclick="toggleActive(${h.id})" title="${h.active?'Ø¥Ø®ÙØ§Ø¡':'Ø¥Ø¸Ù‡Ø§Ø±'}">${h.active?'ğŸ‘':'ğŸ™ˆ'}</div>
        <div class="mgmt-btn del" onclick="deleteHabit(${h.id})" title="Ø­Ø°Ù">ğŸ—‘</div>
      </div>`;
    el.appendChild(row);
  });
}

function toggleActive(id){
  const h=habits.find(x=>x.id===id);
  if(h){
    h.active=!h.active;
    save();
    renderManageList();renderToday();renderOverview();
    sbPatch('habits', 'id=eq.'+id, {active: h.active});
  }
}

function deleteHabit(id){
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø¹Ø§Ø¯Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ')) return;
  habits=habits.filter(x=>x.id!==id);
  save();renderManageList();renderToday();renderOverview();
  showToast('ØªÙ… Ø§Ù„Ø­Ø°Ù','error');
  if(CFG.scriptUrl) deleteHabitFromSheet(id);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function loadSettingsUI(){
  document.getElementById('script-url').value=CFG.scriptUrl||'';
  const mode = localStorage.getItem('theme') || 'dark';
  applyTheme(mode);
}

function saveScriptUrl(){
  const url=document.getElementById('script-url').value.trim();
  CFG.scriptUrl=url;
  save();
  showToast(url?'âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø±Ø§Ø¨Ø· â€” Ø³ÙŠØªÙ… Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø¢Ù†':'ØªÙ… Ø§Ù„Ø­Ø°Ù','info');
  setSyncStatus('syncing','Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©...');syncFromSheet();
}

function changePwd(){
  const old=document.getElementById('old-pwd').value;
  const nw=document.getElementById('new-pwd').value;
  if(old!==CFG.pwd){showToast('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø­Ø§Ù„ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©','error');return;}
  if(nw.length<3){showToast('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© Ù‚ØµÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹','error');return;}
  CFG.pwd=nw;save();
  document.getElementById('old-pwd').value='';
  document.getElementById('new-pwd').value='';
  showToast('âœ… ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±','success');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GOOGLE SHEETS SYNC
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function setSyncStatus(state, label){
  const dot=document.getElementById('sync-dot');
  const lbl=document.getElementById('sync-label');
  dot.className='sync-dot'+(state?' '+state:'');
  lbl.textContent=label;
}

// â•â• Supabase API â•â•
const SB = {
  headers: {
    'apikey': SUPABASE_KEY,
    'Authorization': 'Bearer ' + SUPABASE_KEY,
    'Content-Type': 'application/json',
    'Prefer': 'return=representation'
  }
};

async function sbGet(table, params='') {
  const res = await fetch(SUPABASE_URL + '/rest/v1/' + table + '?' + params, {
    headers: SB.headers
  });
  return res.ok ? res.json() : null;
}

async function sbPost(table, body) {
  const res = await fetch(SUPABASE_URL + '/rest/v1/' + table, {
    method: 'POST',
    headers: SB.headers,
    body: JSON.stringify(body)
  });
  return res.ok;
}

async function sbUpsert(table, body, onConflict) {
  const res = await fetch(SUPABASE_URL + '/rest/v1/' + table + '?on_conflict=' + onConflict, {
    method: 'POST',
    headers: {...SB.headers, 'Prefer': 'resolution=merge-duplicates,return=representation'},
    body: JSON.stringify(body)
  });
  return res.ok;
}

async function sbPatch(table, params, body) {
  const res = await fetch(SUPABASE_URL + '/rest/v1/' + table + '?' + params, {
    method: 'PATCH',
    headers: SB.headers,
    body: JSON.stringify(body)
  });
  return res.ok;
}

async function sbDelete(table, params) {
  const res = await fetch(SUPABASE_URL + '/rest/v1/' + table + '?' + params, {
    method: 'DELETE',
    headers: SB.headers
  });
  return res.ok;
}

async function syncFromSheet(){
  setSyncStatus('syncing','Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...');
  try {
    // Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ø§Ø¯Ø§Øª
    const habitsData = await sbGet('habits', 'select=*&order=id');
    if(!habitsData) { setSyncStatus('error','ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„'); return; }
    habits = habitsData.map(h => ({
      id: h.id, name: h.name, icon: h.icon || 'â­',
      hint: h.hint || '', active: h.active !== false
    }));

    // Ø¬Ù„Ø¨ Ø§Ù„Ø³Ø¬Ù„Ø§Øª
    const logsData = await sbGet('logs', 'select=*');
    if(logsData) {
      logs = {};
      logsData.forEach(l => {
        if(!logs[l.date]) logs[l.date] = {};
        logs[l.date][l.habit_id] = l.value ? 1 : 0;
      });
    }

    // Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø°ÙƒØ±Ø©
    const journalData = await sbGet('journal', 'select=*');
    if(journalData) {
      journal = {};
      journalData.forEach(j => {
        journal[j.date] = {
          date: j.date, mood: j.mood || 0,
          gratitude: j.gratitude || '', note: j.note || '',
          savedAt: j.saved_at || ''
        };
      });
      localStorage.setItem('journal2', JSON.stringify(journal));
    }

    save();
    renderToday();
    renderOverview();
    renderCalendar();
    setSyncStatus('synced','Ù…Ø­Ø¯Ù‘Ø« âœ“');
    setTimeout(()=>setSyncStatus('','Ù…Ø­Ù„ÙŠ'),3000);
    showToast('âœ… ØªÙ…Øª Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø©','success');
  } catch(e) {
    setSyncStatus('error','Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„');
  }
}

async function syncToSheet(habitId, value){
  setSyncStatus('syncing','Ø­ÙØ¸...');
  const ok = await sbUpsert('logs', {date: TODAY, habit_id: habitId, value: value ? true : false}, 'date,habit_id');
  if(ok){ setSyncStatus('synced','ØªÙ… âœ“'); setTimeout(()=>setSyncStatus('','Ù…Ø­Ù„ÙŠ'),2000); }
  else { setSyncStatus('error','Ø®Ø·Ø£'); showToast('ØªØ¹Ø°Ø± Ø§Ù„Ø­ÙØ¸','error'); }
}

async function syncHabitToSheet(h){
  await sbUpsert('habits', {id: h.id, name: h.name, icon: h.icon, hint: h.hint || '', active: true}, 'id');
}

async function deleteHabitFromSheet(id){
  await sbDelete('habits', 'id=eq.' + id);
}

async function syncJournalToSheet(entry){
  await sbUpsert('journal', {
    date: entry.date, mood: entry.mood || 0,
    gratitude: entry.gratitude || '', note: entry.note || '',
    saved_at: entry.savedAt || new Date().toISOString()
  }, 'date');
}

// legacy
async function apiCall(payload){ return null; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let toastTimer;
function showToast(msg, type='info'){
  const t=document.getElementById('toast');
  t.textContent=msg;
  t.className='toast show '+(type||'info');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>t.classList.remove('show'),2200);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   JOURNAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let journal = JSON.parse(localStorage.getItem('journal2') || '{}');
let selectedMood = 0;
const MOOD_EMOJI = {1:'ğŸ˜¤',2:'ğŸ˜”',3:'ğŸ˜',4:'ğŸ™‚',5:'ğŸ˜„'};
const MOOD_LABEL = {1:'Ø³ÙŠØ¡',2:'ØªØ¹Ø¨Ø§Ù†',3:'Ø¹Ø§Ø¯ÙŠ',4:'Ø¬ÙŠØ¯',5:'Ù…Ù…ØªØ§Ø²'};

function initJournal() {
  const el = document.getElementById('journal-today-date');
  if(el) el.textContent = new Date().toLocaleDateString('ar-SA',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  const entry = journal[TODAY];
  if (entry) {
    if (entry.mood) selectMoodById(entry.mood);
    const gEl = document.getElementById('journal-gratitude');
    const nEl = document.getElementById('journal-note');
    if(gEl && entry.gratitude) gEl.value = entry.gratitude;
    if(nEl && entry.note) nEl.value = entry.note;
  } else {
    selectedMood = 0;
    document.querySelectorAll('.mood-btn').forEach(b=>b.classList.remove('selected'));
    const gEl = document.getElementById('journal-gratitude');
    const nEl = document.getElementById('journal-note');
    if(gEl) gEl.value = '';
    if(nEl) nEl.value = '';
  }
  renderJournalEntries();
}

function selectMood(val, el) {
  selectedMood = val;
  document.querySelectorAll('.mood-btn').forEach(b=>b.classList.remove('selected'));
  el.classList.add('selected');
}

function selectMoodById(val) {
  selectedMood = val;
  document.querySelectorAll('.mood-btn').forEach(b=>{
    b.classList.toggle('selected', parseInt(b.dataset.mood)===val);
  });
}

function saveJournalEntry() {
  const gratitude = document.getElementById('journal-gratitude').value.trim();
  const note = document.getElementById('journal-note').value.trim();
  if(!gratitude && !note) { showToast('Ø§ÙƒØªØ¨ Ø´ÙŠØ¦Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹ âœï¸','error'); return; }
  journal[TODAY] = { date:TODAY, mood:selectedMood, gratitude, note, savedAt:new Date().toISOString() };
  localStorage.setItem('journal2', JSON.stringify(journal));
  renderJournalEntries();
  showToast('âœ… ØªÙ… Ø­ÙØ¸ Ù…Ø°ÙƒØ±Ø© Ø§Ù„ÙŠÙˆÙ…','success');
  syncJournalToSheet(journal[TODAY]);
}

function renderJournalEntries() {
  const el = document.getElementById('journal-entries');
  if(!el) return;
  const entries = Object.values(journal).sort((a,b)=>b.date.localeCompare(a.date)).filter(e=>e.date!==TODAY);
  if(!entries.length){
    el.innerHTML=`<div class="journal-empty"><div class="journal-empty-icon">ğŸ“­</div><div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ø³Ø§Ø¨Ù‚Ø© Ø¨Ø¹Ø¯</div></div>`;
    return;
  }
  el.innerHTML = entries.map(e=>{
    const preview = e.note || e.gratitude || '';
    const dateObj = new Date(e.date+'T00:00:00');
    const dateLabel = dateObj.toLocaleDateString('ar-SA',{weekday:'short',month:'short',day:'numeric'});
    const tags = [];
    if(e.mood) tags.push(MOOD_LABEL[e.mood]||'');
    if(e.gratitude) tags.push('Ø§Ù…ØªÙ†Ø§Ù† âœ¨');
    if(e.note) tags.push('Ù…Ù„Ø§Ø­Ø¸Ø§Øª ğŸ“');
    return `<div class="journal-entry" onclick="openEntry('${e.date}')">
      <div class="journal-entry-header">
        <div class="journal-entry-date">${dateLabel}</div>
        <div class="journal-entry-mood">${e.mood?MOOD_EMOJI[e.mood]:''}</div>
      </div>
      <div class="journal-entry-preview">${preview.substring(0,120)}${preview.length>120?'...':''}</div>
      <div class="journal-entry-tags">${tags.map(t=>`<div class="journal-tag">${t}</div>`).join('')}</div>
    </div>`;
  }).join('');
}

function openEntry(date) {
  const e = journal[date];
  if(!e) return;
  const dateObj = new Date(date+'T00:00:00');
  const dateLabel = dateObj.toLocaleDateString('ar-SA',{weekday:'long',year:'numeric',month:'long',day:'numeric'});
  document.getElementById('entry-modal-date').textContent = dateLabel;
  document.getElementById('entry-modal-mood').textContent = e.mood?MOOD_EMOJI[e.mood]:'';
  const gSection = document.getElementById('entry-gratitude-section');
  const nSection = document.getElementById('entry-note-section');
  if(e.gratitude){ gSection.style.display='block'; document.getElementById('entry-modal-gratitude').textContent=e.gratitude; }
  else gSection.style.display='none';
  if(e.note){ nSection.style.display='block'; document.getElementById('entry-modal-note').textContent=e.note; }
  else nSection.style.display='none';
  document.getElementById('entry-modal').classList.add('show');
}
function closeEntryModal(){ document.getElementById('entry-modal').classList.remove('show'); }
function closeEntryIfBg(e){ if(e.target===document.getElementById('entry-modal')) closeEntryModal(); }

</script>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     GOOGLE APPS SCRIPT CODE
     (Ø§Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙÙŠ Apps Script)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
<APPS_SCRIPT>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  Ù…Ø±Ø§ÙÙ‚ â€” Apps Script Ø§Ù„ÙƒØ§Ù…Ù„
//  Ø§Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ ÙƒÙ„Ù‡ ÙÙŠ Apps Script
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function doPost(e) {
  try {
    var raw = e.postData.contents;
    var data;
    // Handle FormData (payload field) or raw JSON
    if (e.parameter && e.parameter.payload) {
      data = JSON.parse(e.parameter.payload);
    } else {
      data = JSON.parse(raw);
    }
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var action = data.action;
    
    if (action === 'getData')       return getData(ss);
    if (action === 'setLog')        return setLog(ss, data.date, data.habitId, data.value);
    if (action === 'addHabit')      return addHabit(ss, data.habit);
    if (action === 'deleteHabit')   return deleteHabit(ss, data.habitId);
    if (action === 'toggleHabit')   return toggleHabitActive(ss, data.habitId, data.active);
    if (action === 'saveJournal')   return saveJournal(ss, data.entry);
    
    return respond({ok: false, error: 'Unknown action'});
  } catch(err) {
    return respond({ok: false, error: err.toString()});
  }
}

function doGet(e) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  return getData(ss);
}

// â”€â”€ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø´ÙŠØª Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¬Ø¯ÙŠØ¯ â”€â”€
function setupSheets(ss) {
  var sheets = ['Habits', 'Logs', 'Journal'];
  sheets.forEach(function(name) {
    if (!ss.getSheetByName(name)) {
      var s = ss.insertSheet(name);
      if (name === 'Habits') {
        s.appendRow(['ID', 'Name', 'Icon', 'Hint', 'Active']);
        s.appendRow([1, 'Ø§Ù„ØµÙ„Ø§Ø© ÙÙŠ ÙˆÙ‚ØªÙ‡Ø§', 'ğŸ•Œ', 'Ø§Ù„ØµÙ„ÙˆØ§Øª Ø§Ù„Ø®Ù…Ø³', 1]);
        s.appendRow([2, 'Ø§Ù„Ù†ÙˆÙ… 7-8 Ø³Ø§Ø¹Ø§Øª', 'ğŸ˜´', 'Ù†ÙˆÙ… Ù…Ù†ØªØ¸Ù…', 1]);
        s.appendRow([3, 'Ø¨Ø¯ÙˆÙ† Ù‡Ø§ØªÙ Ø£ÙˆÙ„ 30 Ø¯Ù‚ÙŠÙ‚Ø©', 'ğŸ“µ', 'Ø¨Ø¹Ø¯ Ø§Ù„Ø§Ø³ØªÙŠÙ‚Ø§Ø¸', 1]);
        s.appendRow([4, 'Ø§Ù„ØªØ®Ø·ÙŠØ· Ù„Ù„ÙŠÙˆÙ…', 'ğŸ“‹', 'Ø¯Ù‚ÙŠÙ‚ØªÙŠÙ† ÙƒØ§ÙÙŠØªÙŠÙ†', 1]);
        s.appendRow([5, 'Ù…Ø´ÙŠ 15 Ø¯Ù‚ÙŠÙ‚Ø©', 'ğŸš¶', 'Ø£ÙŠ ÙˆÙ‚Øª Ù…Ù† Ø§Ù„ÙŠÙˆÙ…', 1]);
        s.appendRow([6, 'Ø´Ø±Ø¨ 8 ÙƒØ§Ø³Ø§Øª Ù…Ø§Ø¡', 'ğŸ’§', '2 Ù„ØªØ± ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹', 1]);
        s.appendRow([7, 'ØªØ¹Ù„Ù… 30-40 Ø¯Ù‚ÙŠÙ‚Ø©', 'ğŸ“š', 'ÙƒÙˆØ±Ø³ Ø£Ùˆ Ù…Ù‡Ø§Ø±Ø©', 1]);
        s.appendRow([8, 'Ø§Ù„Ø¹Ù…Ù„ Ø¹Ù„Ù‰ 3mcars', 'ğŸš—', '30 Ø¯Ù‚ÙŠÙ‚Ø© ÙŠÙˆÙ…ÙŠØ§Ù‹', 1]);
        s.appendRow([9, 'Ù‚Ø±Ø§Ø¡Ø© ÙƒØªØ§Ø¨', 'ğŸ“–', '20 Ø¯Ù‚ÙŠÙ‚Ø©', 1]);
        s.appendRow([10, 'Ù‚Ø±Ø§Ø¡Ø© ØµÙØ­Ø© Ù‚Ø±Ø¢Ù†', 'ğŸŒŸ', 'ÙƒÙ„ ÙŠÙˆÙ… Ø¨Ø¯ÙˆÙ† Ø§Ø³ØªØ«Ù†Ø§Ø¡', 1]);
        s.appendRow([11, 'ØªÙ‚Ù„ÙŠÙ„ Ø§Ù„ÙƒÙ„Ø§Ù… Ø§Ù„Ø²Ø§Ø¦Ø¯', 'ğŸ¤', 'Ø§Ù†ØªØ¨Ù‡ Ù„Ù…Ø§ ØªÙ‚ÙˆÙ„', 1]);
        s.appendRow([12, 'ØªØ±Ùƒ Ø§Ù„Ø¹Ø§Ø¯Ø© Ø§Ù„Ø³ÙŠØ¦Ø©', 'ğŸš«', 'Ø§Ù„ØªØ²Ø§Ù… ÙŠÙˆÙ…ÙŠ', 1]);
      }
      if (name === 'Logs') {
        s.appendRow(['Date']); // columns for habit IDs added dynamically
      }
      if (name === 'Journal') {
        s.appendRow(['Date', 'Mood', 'Gratitude', 'Note', 'SavedAt']);
      }
    }
  });
}

// â”€â”€ Ø¬Ù„Ø¨ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª â”€â”€
function getData(ss) {
  setupSheets(ss);
  
  // Habits
  var habitsSheet = ss.getSheetByName('Habits');
  var habitsRows = habitsSheet.getDataRange().getValues();
  var habits = [];
  for (var i = 1; i < habitsRows.length; i++) {
    if (!habitsRows[i][0]) continue;
    habits.push({
      id:     Number(habitsRows[i][0]),
      name:   habitsRows[i][1] || '',
      icon:   habitsRows[i][2] || 'â­',
      hint:   habitsRows[i][3] || '',
      active: habitsRows[i][4] == 1
    });
  }
  
  // Logs
  var logsSheet = ss.getSheetByName('Logs');
  var logsRows = logsSheet.getDataRange().getValues();
  var logs = {};
  if (logsRows.length > 1) {
    var headers = logsRows[0]; // [Date, habitId1, habitId2, ...]
    for (var i = 1; i < logsRows.length; i++) {
      if (!logsRows[i][0]) continue;
      var ds = Utilities.formatDate(new Date(logsRows[i][0]), 'Asia/Riyadh', 'yyyy-MM-dd');
      logs[ds] = {};
      for (var j = 1; j < headers.length; j++) {
        if (headers[j]) logs[ds][Number(headers[j])] = logsRows[i][j] == 1 ? 1 : 0;
      }
    }
  }
  
  // Journal
  var journalSheet = ss.getSheetByName('Journal');
  var journalRows = journalSheet.getDataRange().getValues();
  var journal = {};
  for (var i = 1; i < journalRows.length; i++) {
    if (!journalRows[i][0]) continue;
    var ds = Utilities.formatDate(new Date(journalRows[i][0]), 'Asia/Riyadh', 'yyyy-MM-dd');
    journal[ds] = {
      date:      ds,
      mood:      journalRows[i][1] || 0,
      gratitude: journalRows[i][2] || '',
      note:      journalRows[i][3] || '',
      savedAt:   journalRows[i][4] || ''
    };
  }
  
  return respond({ok: true, habits: habits, logs: logs, journal: journal});
}

// â”€â”€ ØªØ³Ø¬ÙŠÙ„ Ø¹Ø§Ø¯Ø© Ø§Ù„ÙŠÙˆÙ… â”€â”€
function setLog(ss, date, habitId, value) {
  var sheet = ss.getSheetByName('Logs');
  var data = sheet.getDataRange().getValues();
  var headers = data[0];
  
  // Find column for this habitId (or create it)
  var colIdx = -1;
  for (var j = 1; j < headers.length; j++) {
    if (Number(headers[j]) === Number(habitId)) { colIdx = j; break; }
  }
  if (colIdx === -1) {
    colIdx = headers.length;
    sheet.getRange(1, colIdx + 1).setValue(Number(habitId));
  }
  
  // Find row for this date (or create it)
  var rowIdx = -1;
  for (var i = 1; i < data.length; i++) {
    if (!data[i][0]) continue;
    var ds = Utilities.formatDate(new Date(data[i][0]), 'Asia/Riyadh', 'yyyy-MM-dd');
    if (ds === date) { rowIdx = i; break; }
  }
  if (rowIdx === -1) {
    rowIdx = data.length;
    sheet.getRange(rowIdx + 1, 1).setValue(new Date(date + 'T12:00:00'));
  }
  
  sheet.getRange(rowIdx + 1, colIdx + 1).setValue(value ? 1 : 0);
  return respond({ok: true});
}

// â”€â”€ Ø¥Ø¶Ø§ÙØ© Ø¹Ø§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø© â”€â”€
function addHabit(ss, habit) {
  var sheet = ss.getSheetByName('Habits');
  sheet.appendRow([
    Number(habit.id),
    habit.name   || '',
    habit.icon   || 'â­',
    habit.hint   || '',
    habit.active ? 1 : 0
  ]);
  return respond({ok: true});
}

// â”€â”€ Ø­Ø°Ù Ø¹Ø§Ø¯Ø© â”€â”€
function deleteHabit(ss, habitId) {
  var sheet = ss.getSheetByName('Habits');
  var data = sheet.getDataRange().getValues();
  for (var i = 1; i < data.length; i++) {
    if (Number(data[i][0]) === Number(habitId)) {
      sheet.deleteRow(i + 1);
      return respond({ok: true});
    }
  }
  return respond({ok: false, error: 'Habit not found'});
}

// â”€â”€ Ø¥Ø®ÙØ§Ø¡/Ø¥Ø¸Ù‡Ø§Ø± Ø¹Ø§Ø¯Ø© â”€â”€
function toggleHabitActive(ss, habitId, active) {
  var sheet = ss.getSheetByName('Habits');
  var data = sheet.getDataRange().getValues();
  for (var i = 1; i < data.length; i++) {
    if (Number(data[i][0]) === Number(habitId)) {
      sheet.getRange(i + 1, 5).setValue(active ? 1 : 0);
      return respond({ok: true});
    }
  }
  return respond({ok: false});
}

// â”€â”€ Ø­ÙØ¸ Ù…Ø°ÙƒØ±Ø© â”€â”€
function saveJournal(ss, entry) {
  var sheet = ss.getSheetByName('Journal');
  var data = sheet.getDataRange().getValues();
  var rowIdx = -1;
  for (var i = 1; i < data.length; i++) {
    if (!data[i][0]) continue;
    var ds = Utilities.formatDate(new Date(data[i][0]), 'Asia/Riyadh', 'yyyy-MM-dd');
    if (ds === entry.date) { rowIdx = i + 1; break; }
  }
  var row = [
    new Date(entry.date + 'T12:00:00'),
    entry.mood      || 0,
    entry.gratitude || '',
    entry.note      || '',
    entry.savedAt   || new Date().toISOString()
  ];
  if (rowIdx > 0) {
    sheet.getRange(rowIdx, 1, 1, 5).setValues([row]);
  } else {
    sheet.appendRow(row);
  }
  return respond({ok: true});
}

// â”€â”€ Helper â”€â”€
function respond(data) {
  return ContentService
    .createTextOutput(JSON.stringify(data))
    .setMimeType(ContentService.MimeType.JSON);
}
</APPS_SCRIPT>
-->
</body>
</html>
